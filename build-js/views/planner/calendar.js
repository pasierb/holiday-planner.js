define(["jquery","underscore","backbone","i18next","text!templates/planner.html","views/planner/year_changer","views/planner/day","views/planner/info_bar","models/day","collections/leave"],function(e,t,n,r,i,s,o,u,a,f){var l=n.View.extend({initialize:function(e){this.year=e.year||(new Date).getFullYear(),this.location="pl",this.vent=e.vent,this.leave=new f,t.bindAll(this,"setYear","markDay","unmarkDay","setLocation","render"),e.vent.bind("setYear",this.setYear),e.vent.bind("markDay",this.markDay),e.vent.bind("unmarkDay",this.unmarkDay),e.vent.bind("setLocation",this.setLocation),e.vent.bind("i18n:loaded",this.render)},setYear:function(e){this.year=e,this.render()},setLocation:function(e){this.location=e,this.render()},el:"#planner-calendar",render:function(){this.$el.html(""),this.publicHolidays=this.publicHolidaysMap();var n=this,r=new Date,i=new u({vent:this.vent});$result=e("<div></div>",{"class":"calendar-container"}),r.setFullYear(this.year),r.setMonth(0);while(r.getFullYear()===this.year)$result.append(this.renderMonth(r.getMonth())),r.setMonth(r.getMonth()+1);i.render(),this.$el.append($result),this.leave.fetch({success:function(r){t.each(r.models,function(t){var r=new Date(t.get("date"));e("[data-date='"+n.dateString(r)+"']",n.$el).trigger("setModel",t)})}})},renderMonth:function(t){var n=new Date,i=e("<div></div>",{"class":"month"}),s="date.month."+t,u=e("<div></div>",{"class":"heading",html:r.exists(s)?r.t(s):t+1}),f;i.append(u),n.setFullYear(this.year),n.setMonth(t),n.setDate(1);for(var l=0;l<n.getDay();l++)i.append(e("<div></div>",{"class":"empty"}));while(n.getMonth()==t)f=new o({model:new a({date:n}),vent:this.vent,holiday:this.publicHolidays[this.dateString(n)]}),i.append(f.render().$el),n.setDate(n.getDate()+1);return i},publicHolidaysMap:function(){var e={};PublicHolidays.setFactory(this.location);var n=PublicHolidays.all(this.year);return t.each(n,function(t){var n=t.date.getMonth()+1+"-"+t.date.getDate()+"-"+t.date.getFullYear();e[n]=t}),e},markDay:function(e,t){this.leave.add(t),t.save(),this.markPeriod(e)},unmarkDay:function(e,t){t.destroy(),this.unmarkPeriod(e)},dateString:function(e){return e.getMonth()+1+"-"+e.getDate()+"-"+e.getFullYear()},nextDay:function(t){return e("[data-date='"+this.dateString(t.addDays(1))+"']",this.$el)},prevDay:function(t){return e("[data-date='"+this.dateString(t.addDays(-1))+"']",this.$el)},markPeriod:function(e){var t=new Date(e.data("date")),n=new Date(e.data("date")),r=this.nextDay(t),i=this.prevDay(n);e.addClass("period");while(r.length>0&&r.attr("class").match(/(weekend|holiday|leave)/))r.addClass("period"),r=this.nextDay(t);while(i.length>0&&i.attr("class").match(/(weekend|holiday|leave)/))i.addClass("period"),i=this.prevDay(n)},unmarkPeriod:function(e){var t=new Date(e.data("date")),n=new Date(e.data("date")),r=this.nextDay(t),i=this.prevDay(n);e.removeClass("period");while(r.attr("class").match(/(period|leave)/)){r.removeClass("period");if(r.hasClass("leave")){this.markPeriod(r);break}r=this.nextDay(t)}while(i.attr("class").match(/(period|leave)/)){i.removeClass("period");if(i.hasClass("leave")){this.markPeriod(i);break}i=this.prevDay(n)}},dateString:function(e){return e.getMonth()+1+"-"+e.getDate()+"-"+e.getFullYear()}});return l});